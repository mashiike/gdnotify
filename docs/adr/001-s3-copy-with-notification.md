# ADR-001: EventBridge通知時のオプショナルS3コピー機能

**ステータス**: 適用

## コンテキスト

gdnotifyはGoogle Driveの変更をEventBridge経由で通知しているが、通知にはメタデータのみが含まれ、ファイル本体は含まれない。

典型的な構成は「EventBridge通知を受け取った後続処理（Lambda等）がGoogle Drive APIを呼び出してS3にダウンロード」する流れであり、次の課題があった。

1. **後続処理の複雑化**: 各後続処理がGoogle Drive APIの認証・ファイル取得ロジックを実装する必要がある
2. **認証情報の分散**: gdnotifyと後続処理の両方がGoogle Driveの認証情報を持つ必要がある
3. **重複実装**: 複数の後続処理が同じファイル取得ロジックを実装することがある

## 決定

EventBridge通知の**オプション機能**として、gdnotifyがGoogle DriveからファイルをS3へコピーし、そのS3 URIを通知に含める。

設定は **YAML設定ファイル + CEL（Common Expression Language）** を採用し、`rules` を上から順に評価する。

ルールの評価結果に応じて以下を適用する。

- 最初にマッチしたルールを適用
- `skip: true` のルールはコピーしない
- どのルールにもマッチしない場合はコピーしない
- `change.removed=true` の場合はコピーしない

通知ペイロードには `s3Copy` を追加し、コピーに成功した場合のみ付与する。

## 理由

1. **柔軟性**: MIMEタイプ・ファイルサイズ・フォルダ・ユーザーなどの条件をCEL式で表現できる
2. **デファクト**: CELはKubernetes ValidatingAdmissionPolicy、Google Cloud IAM Conditions等で標準的に使われている
3. **動的パス生成**: `object_key` をCEL式で柔軟に生成できる
4. **バージョン管理**: 設定ファイルをGit管理できる

### 検討した代替案

- **JSON設定 + 独自DSL**: 実装の自由度は高いが、学習コストと長期の保守コストが増える
- **JSON設定 + JSONPath/JMESPath**: 条件表現は可能だが、式の拡張性と型安全性が限定的
- **固定ルール（CLIフラグのみ）**: 導入は容易だが、ユースケースが増えると設定が破綻する
- **下流処理にS3コピーを任せる**: 既存構成を維持できるが、認証情報の分散と実装重複が解消されない

## 結果

- 下流処理からGoogle Drive API認証・ダウンロード実装が不要になり、S3から直接取得できる
- S3コピーに必要なIAM権限（`s3:PutObject` など）が追加で必要になる
- Google Workspaceファイルはエクスポート処理が必要であり、`export` を省略した場合は `pdf` が既定値となる
- S3コピー失敗時は警告ログを出し、通知自体は継続する（`s3Copy` は付与されない）
